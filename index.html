<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#A2AE83">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hazel">
    <title>Hazel - Mental Health Support</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhhemVsIC0gTWVudGFsIEhlYWx0aCBTdXBwb3J0IiwKICAic2hvcnRfbmFtZSI6ICJIYXplbCIsCiAgImRlc2NyaXB0aW9uIjogIk1lbnRhbCBoZWFsdGggc3VwcG9ydCBhcHAgd2l0aCBqb3VybmFsaW5nLCByZXNvdXJjZXMsIGFuZCBjcmlzaXMgc3VwcG9ydCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjQTJBRTgzIiwKICAidGhlbWVfY29sb3IiOiAiI0EyQUU4MyIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIZHBaSFJvUFNJeE9USmNJaUJvWldsbmFIUTlJakU1TW5jaUlIWnBaWGRDYjNnOUlqQWdNQ0F4T1RJZ01UazJYQ0krUEhKbFkzUWdkMmxrZEdnOUlqRTVNaUlnYUdWcFoyaDBQU0l4T1RJaUlHWnBiR3c5SWlOQk1rRkZPRE5jSWk4K1BIUmxlSFFnZUQwaU9UWWlJSGs5SWpFeE1DSUJHYIUZ1ZEMxemFYcGxQU0k0TkNJZ2RHVjRkQzFoYm1Ob2IzSTlJbTFwWkdSc1pTSStxS2FzOERBdmRHVjRkRDQ4TDNOMlp6ND0iLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIZHBaSFJvUFNJMU1USndlQ0lnYUdWcFoyaDBQU0kxTVRKd2VDSWdkbWxsZDBKdmVEMGlNQ0F3SURRNU1UZ3dYQ0krUEhKbFkzUWdkMmxrZEdnOUlqVXhNaUlnYUdWcFoyaDBQU0kxTVRJaUlHWnBiR3c5SWlOQk1rRkZPRE5jSWk4K1BIUmxlSFFnZUQwaU1qVTJJaUJaUFNJek1EQWlJR1p2Ym5RdGMybDZaVDBpTWpBd0lpQjBaWGgwTFdGdVkyaHZjajBpYldsa1pHeGxYQ0lrcUthczhEQXZkR1Y0ZEQ0OEwzTjJaejQ9IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0sCiAgInNob3J0Y3V0cyI6IFsKICAgIHsKICAgICAgIm5hbWUiOiAiTmV3IEpvdXJuYWwgRW50cnkiLAogICAgICAic2hvcnRfbmFtZSI6ICJKb3VybmFsIiwKICAgICAgInVybCI6ICIvP2FjdGlvbj1uZXctam91cm5hbCIKICAgIH0sCiAgICB7CiAgICAgICJuYW1lIjogIkNyaXNpcyBTdXBwb3J0IiwKICAgICAgInNob3J0X25hbWUiOiAiQ3Jpc2lzIiwKICAgICAgInVybCI6ICIvP2FjdGlvbj1jcmlzaXMiCiAgICB9CiAgXQp9">

    <!-- Apple Touch Icons for iOS PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiNBMkFFODMiLz48dGV4dCB4PSI5MCIgeT0iMTEwIiBmb250LXNpemU9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFwcGxlIENvbG9yIEVtb2ppLCBTZWdvZSBVSSBFbW9qaSwgTm90byBDb2xvciBFbW9qaSwgc2Fucy1zZXJpZiI+8J+MsDwvdGV4dD48L3N2Zz4=">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgdmlld0JveD0iMCAwIDE1MiAxNTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE1MiIgaGVpZ2h0PSIxNTIiIGZpbGw9IiNBMkFFODMiLz48dGV4dCB4PSI3NiIgeT0iOTIiIGZvbnQtc2l6ZT0iODQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcHBsZSBDb2xvciBFbW9qaSwgU2Vnb2UgVUkgRW1vamksIE5vdG8gQ29sb3IgRW1vamksIHNhbnMtc2VyaWYiPvCfjLA8L3RleHQ+PC9zdmc+">
    <link rel="apple-touch-icon" sizes="120x120" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNBMkFFODMiLz48dGV4dCB4PSI2MCIgeT0iNzMiIGZvbnQtc2l6ZT0iNjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcHBsZSBDb2xvciBFbW9qaSwgU2Vnb2UgVUkgRW1vamksIE5vdG8gQ29sb3IgRW1vamksIHNhbnMtc2VyaWYiPvCfjLA8L3RleHQ+PC9zdmc+">
    <!-- Fallback Apple Touch Icon (catches all other sizes) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiNBMkFFODMiLz48dGV4dCB4PSI5MCIgeT0iMTEwIiBmb250LXNpemU9IjEwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFwcGxlIENvbG9yIEVtb2ppLCBTZWdvZSBVSSBFbW9qaSwgTm90byBDb2xvciBFbW9qaSwgc2Fucy1zZXJpZiI+8J+MsDwvdGV4dD48L3N2Zz4=">

    <style>
        /* CSS Custom Properties for Mobile-First Design */
        :root {
            /* Color System */
            --primary-color: #A2AE83;
            --primary-dark: #8B956C;
            --primary-light: #B8C19D;
            --secondary-color: #B088F9;
            --accent-color: #BA6464;
            --background-color: #A2AE83;
            --surface-color: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-on-primary: #FFFFFF;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            
            /* Fluid Typography */
            --text-xs: clamp(0.75rem, 1.5vw + 0.5rem, 0.875rem);
            --text-sm: clamp(0.875rem, 2vw + 0.5rem, 1rem);
            --text-base: clamp(1rem, 2.5vw + 0.5rem, 1.125rem);
            --text-lg: clamp(1.125rem, 3vw + 0.5rem, 1.25rem);
            --text-xl: clamp(1.25rem, 4vw + 0.5rem, 1.5rem);
            --text-2xl: clamp(1.5rem, 5vw + 0.5rem, 2rem);
            --text-3xl: clamp(2rem, 6vw + 0.5rem, 3rem);
            --text-4xl: clamp(2.5rem, 8vw + 0.5rem, 4rem);
            
            /* Responsive Spacing */
            --space-xs: clamp(0.25rem, 1vw, 0.5rem);
            --space-sm: clamp(0.5rem, 2vw, 1rem);
            --space-md: clamp(1rem, 3vw, 1.5rem);
            --space-lg: clamp(1.5rem, 4vw, 2rem);
            --space-xl: clamp(2rem, 5vw, 3rem);
            --space-2xl: clamp(3rem, 6vw, 4rem);
            
            /* Border Radius */
            --radius-sm: 0.5rem;
            --radius-md: 1rem;
            --radius-lg: 1.5rem;
            --radius-xl: 2rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            
            /* Z-index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
            
            /* Safe Areas */
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-right: env(safe-area-inset-right);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
        }

        /* Reset and Base Styles */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
            height: 100%;
            height: 100dvh;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100%;
            height: 100dvh;
            padding-top: var(--safe-area-inset-top);
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
            padding-bottom: var(--safe-area-inset-bottom);
            font-size: var(--text-base);
            position: relative;
        }

        /* Enhanced Container System */
        /* UPDATED WITH iOS FIX */
        .container {
            width: 100%;
            height: 100vh;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
    
        /* Mobile-First Navigation Bar */
        .nav-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            padding: var(--space-sm) 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            z-index: var(--z-fixed);
            border-top: 1px solid rgba(0,0,0,0.1);
            position: relative;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-sm);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: var(--radius-sm);
            margin: 0 var(--space-xs);
            min-height: 44px;
            text-decoration: none;
            color: inherit;
            position: relative;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 50%;
            width: 20px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px;
            transform: translateX(-50%) scaleX(0);
            transition: transform 0.2s ease;
        }

        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-xs);
            transition: transform 0.2s ease;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-text {
            font-size: var(--text-xs);
            font-weight: 600;
            text-align: center;
        }

        #menus {
                padding-top: var(--space-xl);
        }       
        
        /* Enhanced Page System */
        /* UPDATED WITH iOS FIX */
        .page {
            display: none;
            flex: 1;
            padding: var(--space-md);
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            min-height: 0; /* This is crucial - allows flex shrinking */
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Page Styles */
        /* UPDATED WITH iOS FIX */
        .home-header {
            text-align: center;
            margin-bottom: var(--space-lg);
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: space-around;
            min-height: 0;
        }

        .logo {
            width: clamp(80px, 20vw, 120px);
            height: clamp(80px, 20vw, 120px);
            background: linear-gradient(135deg, #556B2F, #6B7F3F);
            border-radius: var(--radius-lg);
            margin: 0 auto var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(2rem, 8vw, 3rem);
            color: white;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: rotate(45deg);
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoShine {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .feeling-text {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--space-lg);
            color: white;
        }

        .emoji-container {
            display: flex;
            justify-content: space-between;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
            padding: 0 var(--space-lg);
            flex-wrap: wrap;
            align-items: center;
        }

        .emoji-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: var(--radius-full);
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            min-height: 60px;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
        }

        .emoji-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .emoji-btn:hover::before,
        .emoji-btn:focus::before {
            width: 100px;
            height: 100px;
        }

        .emoji-btn:hover,
        .emoji-btn:focus {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .emoji-btn:active {
            transform: scale(0.95);
        }

        /* Sobriety Tracker */
        .sobriety-tracker {
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            color: white;
            backdrop-filter: blur(10px);
            margin-bottom: var(--space-lg);
            position: relative;
            overflow: hidden;
        }

        .sobriety-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .sobriety-title {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .edit-btn {
            background: none;
            border: none;
            color: white;
            font-size: var(--text-lg);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: background 0.2s ease;
        }

        .edit-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .days-counter {
            text-align: center;
            margin-bottom: var(--space-md);
        }

        .days-number {
            font-size: var(--text-4xl);
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .days-text {
            font-size: var(--text-base);
            opacity: 0.8;
        }

        .motivation-text {
            text-align: center;
            font-style: italic;
            opacity: 0.9;
            margin-bottom: var(--space-md);
        }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: var(--space-sm);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transition: width 0.3s ease;
        }

        .milestone-text {
            text-align: center;
            font-size: var(--text-sm);
            opacity: 0.8;
        }

        /* Enhanced Dashboard Layout */
        .dashboard-container {
            display: flex;
            flex: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            max-height: 100%;
        }

        .tab-sidebar {
            width: 80px;
            background: #000;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: var(--text-xs);
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
            transition: all 0.2s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: var(--space-sm);
            position: relative;
            min-height: 60px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform 0.2s ease;
        }

        .tab-item.active::before {
            transform: scaleY(1);
        }

        .tab-item:nth-child(1) { background: #FFFFFF; color: #000; }
        .tab-item:nth-child(2) { background: #8FAE79; }
        .tab-item:nth-child(3) { background: #678553; }
        .tab-item:nth-child(4) { background: #45582F; }

        .tab-content {
            flex: 1;
            background: #A9B189;
            padding: var(--space-lg);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section-title {
            color: white;
            font-size: var(--text-xl);
            font-weight: 700;
            text-align: center;
            margin-bottom: var(--space-sm);
        }

        .section-divider {
            height: 1px;
            background: white;
            margin-bottom: var(--space-lg);
            opacity: 0.7;
        }

        .alternatives-list {
            color: white;
            line-height: 1.8;
            margin-bottom: var(--space-xl);
            font-size: var(--text-base);
        }

        .resource-btn {
            display: block;
            width: 100%;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            background: #C2ABF9;
            color: #000;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
        }

        .resource-btn:hover,
        .resource-btn:focus {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Menu Categories */
        .menu-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            height: 100%;
            max-height: calc(100vh - 200px); /* Account for header and nav */
            overflow: hidden; /* Remove scrolling */
        }
        
        .menu-category {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg); /* Reduced from var(--space-xl) */
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            height: 100%; /* Fill grid cell */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-category::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .menu-category:hover::before {
            left: 100%;
        }

        .menu-category:hover,
        .menu-category:focus {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .category-icon {
            font-size: clamp(2.5rem, 6vw, 4rem); /* Reduced from clamp(3rem, 8vw, 5rem) */
            margin-bottom: var(--space-sm); /* Reduced spacing */
            display: block;
        }

        .category-title {
            font-size: var(--text-xl);
            font-weight: 700;
            color: #435334;
        }

        /* Support Panel */
        .support-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-modal);
            display: none;
            max-width: min(90vw, 320px);
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .support-panel.show {
            display: block;
            animation: supportPanelSlideIn 0.3s ease;
        }

        @keyframes supportPanelSlideIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .support-panel h3 {
            color: white;
            text-align: center;
            margin-bottom: var(--space-lg);
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .support-btn {
            display: block;
            width: 100%;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border: none;
            border-radius: var(--radius-full);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            position: relative;
            overflow: hidden;
        }

        .support-btn.primary {
            background: var(--secondary-color);
            color: white;
        }

        .support-btn.danger {
            background: var(--accent-color);
            color: white;
        }

        .support-btn.secondary {
            background: white;
            color: var(--text-primary);
        }

        /* Journal Styles */
        .journal-header {
            text-align: center;
            margin-bottom: var(--space-xl);
            flex-shrink: 0;
        }

        .journal-title {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: #435334;
            margin-bottom: var(--space-lg);
        }

        .new-entry-btn {
            background: var(--surface-color);
            color: #435334;
            border: none;
            padding: var(--space-lg) var(--space-xl);
            border-radius: var(--radius-full);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: var(--space-lg) 0;
            min-height: 48px;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }

        .new-entry-btn:hover,
        .new-entry-btn:focus {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .journal-entries {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .journal-entry {
            background: var(--surface-color);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .journal-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        .journal-entry:hover,
        .journal-entry:focus {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .entry-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: #435334;
            margin-bottom: var(--space-xs);
        }

        .entry-date {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .entry-mood {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            font-size: 1.2rem;
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            margin: var(--space-2xl) 0;
            padding: var(--space-xl);
            background: rgba(255,255,255,0.5);
            border-radius: var(--radius-lg);
        }

        /* To-Do List Styles */
        .todo-container {
            display: flex;
            flex-direction: column;
            height: 100%; /* Change from flex: 1 to height: 100% */
            gap: var(--space-lg);
            min-height: 0;
        }
        
        .todo-title {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: white;
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .add-task-container {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .task-input {
            flex: 1;
            padding: var(--space-md);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: var(--radius-full);
            background: rgba(255,255,255,0.9);
            font-size: var(--text-base);
            transition: all 0.2s ease;
            min-height: 48px;
        }

        .task-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            background: white;
        }

        .add-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-full);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .add-btn:hover,
        .add-btn:focus {
            background: #9966E6;
            transform: scale(1.05);
        }

        .tasks-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            color: white;
            backdrop-filter: blur(10px);
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .task-checkbox.completed {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .task-checkbox.completed::after {
            content: '✓';
            color: white;
            font-size: 14px;
        }

        .task-text {
            flex: 1;
            transition: all 0.3s ease;
            font-size: var(--text-base);
        }

        .task-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* Form Styles */
        .entry-form {
            background: var(--surface-color);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
            max-height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #435334;
            margin-bottom: var(--space-sm);
            font-size: var(--text-base);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid #ddd;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: space-between;
        }

        .btn {
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 2px solid #ddd;
        }

        .btn:hover, .btn:focus {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .hotline-card {
            background: linear-gradient(135deg, var(--accent-color), #d67676);
            color: white;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-md);
            text-align: center;
        }

        .hotline-title {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-md);
        }

        .hotline-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
        }

        .hotline-call, .hotline-info {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .hotline-call:hover, .hotline-info:hover {
            background: rgba(255,255,255,0.3);
        }

        .close-modal {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            margin-top: var(--space-lg);
            min-height: 48px;
        }
                .task-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .task-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            width: 100%;
        }
        
        .task-actions {
            display: flex;
            gap: var(--space-xs);
            opacity: 0.7;
        }
        
        .task-expand-btn,
        .add-subtask-btn {
            background: none;
            border: none;
            color: white;
            font-size: var(--text-sm);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }
        
        .task-expand-btn:hover,
        .add-subtask-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
        }
          
        .subtask-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .subtask-item:last-child {
            border-bottom: none;
        }
        
        .subtask-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .subtask-checkbox.completed {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .subtask-checkbox.completed::after {
            content: '✓';
            color: white;
            font-size: 10px;
        }
        
        .subtask-text {
            flex: 1;
            font-size: var(--text-sm);
            transition: all 0.3s ease;
        }
        
        .subtask-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .subtask-input {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: var(--radius-sm) !important;
            padding: var(--space-sm) !important;
            color: white !important;
            font-size: var(--text-sm) !important;
            margin-top: var(--space-sm) !important;
            width: 100% !important;
            position: relative !important;
            z-index: 10 !important;
            min-height: 32px !important;
        }
        
        .subtask-input:focus {
            outline: none !important;
            border-color: var(--secondary-color) !important;
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        .subtask-input::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        
        /* Make sure the subtasks container is visible */
        .subtasks {
            margin-left: var(--space-lg) !important;
            padding-left: var(--space-md) !important;
            border-left: 2px solid rgba(255, 255, 255, 0.2) !important;
            display: none !important;
            margin-top: var(--space-sm) !important;
        }
        
        .subtasks.expanded {
            display: block !important;
        }
        /* Emergency Button */
        .emergency-btn {
            position: absolute;
            top: calc(20px + var(--safe-area-inset-top));
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: var(--z-tooltip);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
            transition: all 0.2s ease;
            display: none;
            animation: pulse 2s infinite;
        }

        .emergency-btn.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(255, 68, 68, 0.8); }
            100% { box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4); }
        }

        /* Updated Responsive Design - KEEPS VERTICAL TABS */
        @media (max-width: 768px) {
            /* Keep dashboard container as horizontal flex (vertical tabs) */
            .dashboard-container {
                /* Keep default flex-direction: row */
                /* Keep default height: 100% */
            }
            
            /* Make tab-sidebar narrower on mobile but keep vertical */
            .tab-sidebar {
                width: 60px; /* Narrower than desktop (80px) */
                /* Keep flex-direction: column (default) */
                /* Keep default order */
                flex-shrink: 0;
            }
            
            /* Make tab items smaller but keep vertical orientation */
            .tab-item {
                font-size: 10px; /* Smaller text for mobile */
                padding: 4px; /* Less padding */
                /* Keep writing-mode: vertical-rl (default) */
                /* Keep text-orientation: mixed (default) */
                min-height: 50px; /* Slightly smaller min-height */
            }
            
            /* Keep tab content layout */
            .tab-content {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
            }
            
            /* Keep vertical indicator positioning */
            .tab-item::before {
                left: 0;
                top: 0;
                bottom: 0;
                width: 3px;
                transform: scaleY(0); /* Keep Y scale for vertical indicator */
            }
            
            .tab-item.active::before {
                transform: scaleY(1); /* Keep Y scale for vertical indicator */
            }

            /* Keep all other responsive functionality */
            .form-actions {
                flex-direction: column;
            }

            .hotline-actions {
                flex-direction: column;
            }

            .page {
                display: none;
                flex: 1;
                padding: var(--space-md);
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                min-height: 0;
            }
        }

        @media (max-width: 480px) {
            /* Make tabs even narrower on very small screens but still vertical */
            .tab-sidebar {
                width: 50px;
            }
            
            .tab-item {
                font-size: 9px;
                padding: 2px;
                min-height: 45px;
            }
            
            .page {
                padding: var(--space-xs);
            }
            
            .emoji-container {
                padding: var(--space-md);
                gap: var(--space-xs);
            }
            
            .emoji-btn {
                min-height: 50px;
                min-width: 50px;
                font-size: clamp(1.5rem, 5vw, 2rem);
                padding: var(--space-sm);
            }
            
            .sobriety-tracker {
                padding: var(--space-md);
                margin: var(--space-sm) 0;
            }

            .home-header {
                margin-bottom: var(--space-sm);
            }

            .days-number {
                font-size: var(--text-3xl);
            }

            .entry-form {
                padding: var(--space-md);
            }

            .modal-content {
                padding: var(--space-md);
                max-width: 95vw;
            }
        }

        /* Accessibility */
        .nav-item:focus,
        .emoji-btn:focus,
        .btn:focus,
        .edit-btn:focus,
        .task-checkbox:focus,
        .mood-btn:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Touch feedback for mobile */
        @media (hover: none) and (pointer: coarse) {
            .nav-item:active,
            .emoji-btn:active,
            .btn:active,
            .task-checkbox:active,
            .mood-btn:active {
                transform: scale(0.98);
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .nav-item.active {
                background: var(--primary-color);
                color: white;
            }
            
            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Loading state */
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Fullscreen PWA Styles */
        .fullscreen-mode {
            position: relative;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        /* Hide address bar on mobile when in fullscreen */
        @media (display-mode: fullscreen) {
            body {
                padding-top: 0;
            }
        }

        /* Standalone display mode */
        @media (display-mode: standalone) {
            body {
                padding-top: 0;
            }
            
            .emergency-btn {
                top: 20px;
            }
        }

        /* iOS Safari fullscreen adjustments */
        /* iOS-specific safe area handling */
        @supports (-webkit-touch-callout: none) {
            .container {
                height: -webkit-fill-available;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="home-header">
                <div class="logo">🌰</div>
                <div class="feeling-text">How are you feeling?</div>
                <div class="emoji-container">
                    <button class="emoji-btn" data-mood="very-sad" aria-label="Very sad">😢</button>
                    <button class="emoji-btn" data-mood="sad" aria-label="Sad">😔</button>
                    <button class="emoji-btn" data-mood="neutral" aria-label="Neutral">😐</button>
                    <button class="emoji-btn" data-mood="happy" aria-label="Happy">😊</button>
                    <button class="emoji-btn" data-mood="very-happy" aria-label="Very happy">😄</button>
                </div>

                <!-- Sobriety Tracker -->
                <div class="sobriety-tracker">
                    <div class="sobriety-header">
                        <div class="sobriety-title">Sobriety Tracker</div>
                        <button class="edit-btn" id="editSobrietyBtn" aria-label="Edit sobriety date">✏️</button>
                    </div>
                    <div class="days-counter">
                        <div class="days-number" id="sobrietyDays">0</div>
                        <div class="days-text">days</div>
                    </div>
                    <div class="motivation-text" id="motivationText">
                        Every day is a victory! Your journey starts now.
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="milestone-text" id="milestoneText">Next milestone: 7 days</div>
                </div>

                <!-- Streak Display -->
                <div class="streak-container" id="streakContainer" aria-label="Login streak"></div>
            </div>
        </div>

        <!-- Dashboard/Resources Page -->
        <div id="dashboard" class="page">
            <div class="dashboard-container">
                <div class="tab-sidebar">
                    <div class="tab-item active" data-tab="self-harm">SELF HARM</div>
                    <div class="tab-item" data-tab="ed">ED</div>
                    <div class="tab-item" data-tab="anxiety">ANXIETY</div>
                    <div class="tab-item" data-tab="depression">GENERAL</div>
                </div>
                <div class="tab-content" id="tabContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Journal Page -->
        <div id="journal" class="page">
            <div class="journal-header">
                <div class="journal-title">Journal</div>
                <button class="new-entry-btn" id="newEntryBtn">+ New Entry</button>
            </div>
            <div class="journal-entries" id="journalEntries">
                <div class="empty-state">Start writing to track your thoughts and feelings.</div>
            </div>
        </div>

        <!-- Menus Page -->
        <div id="menus" class="page">
             <div id="menu-categories-view" class="menu-view active">
                <h2 style="text-align: center; margin-bottom: var(--space-lg); font-size: var(--text-2xl); font-weight: 700;">Food Recipes</h2>
                <div class="menu-categories" id="menuCategories">
                    <div class="menu-category" data-category="breakfasts">
                        <div class="category-icon">🥞</div>
                        <div class="category-title">Breakfasts</div>
                    </div>
                    <div class="menu-category" data-category="lunches">
                        <div class="category-icon">🥗</div>
                        <div class="category-title">Lunches</div>
                    </div>
                    <div class="menu-category" data-category="dinners">
                        <div class="category-icon">🍽️</div>
                        <div class="category-title">Dinners</div>
                    </div>
                    <div class="menu-category" data-category="snacks">
                        <div class="category-icon">🍪</div>
                        <div class="category-title">Snacks</div>
                    </div>
                </div>
            </div>
          
        <!-- To-Do List Page -->
        <div id="todo" class="page">
            <div class="todo-container">
                <div class="todo-title">To-Do List</div>
                
                <div class="add-task-container">
                    <input type="text" id="taskInput" class="task-input" placeholder="Add a new task..." maxlength="100" autocomplete="off">
                    <button class="add-btn" id="addTaskBtn">ADD</button>
                </div>

                <div class="tasks-container" id="tasksContainer">
                    <div style="text-align: center; opacity: 0.7; padding: var(--space-xl);">No tasks yet. Add one above!</div>
                </div>
            </div>
        </div>

        <!-- Support Panel -->
        <div class="support-panel" id="supportPanel">
            <h3>We're here to help</h3>
            <button class="support-btn primary" data-action="journal">Write in Journal</button>
            <button class="support-btn danger" data-action="hotlines">Emergency Hotlines</button>
            <button class="support-btn secondary" data-action="dashboard">Find Resources</button>
            <button class="support-btn secondary" data-action="close">I'm OK for now</button>
        </div>

        <!-- Hotlines Modal -->
        <div class="modal" id="hotlinesModal">
            <div class="modal-content">
                <h3 style="text-align: center; margin-bottom: var(--space-lg); color: #435334;">Crisis Support</h3>
                
                <div class="hotline-card">
                    <div class="hotline-title">Samaritans</div>
                    <div class="hotline-actions">
                        <button class="hotline-call" data-number="116123">CALL FREE</button>
                        <button class="hotline-info" data-url="https://www.samaritans.org">More Info</button>
                    </div>
                </div>

                <div class="hotline-card">
                    <div class="hotline-title">BodyWhys</div>
                    <div class="hotline-actions">
                        <button class="hotline-call" data-number="1890200444">CALL NOW</button>
                        <button class="hotline-info" data-url="https://bodywhys.ie">More Info</button>
                    </div>
                </div>

                <div class="hotline-card">
                    <div class="hotline-title">Pieta House</div>
                    <div class="hotline-actions">
                        <button class="hotline-call" data-number="1800901234">CALL NOW</button>
                        <button class="hotline-info" data-url="https://www.pieta.ie/how-we-can-help">More Info</button>
                    </div>
                </div>

                <button class="close-modal" id="closeModalBtn">Back</button>
            </div>
        </div>
                    <!-- Live announcements for screen readers -->
        <div id="live-announcements" aria-live="polite" aria-atomic="true" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>
    </div>

        <!-- Navigation Bar -->
        <nav class="nav-bar" role="navigation" aria-label="Main navigation">
            <div class="nav-item" data-page="menus" role="tab" aria-label="Food menus">
                <div class="nav-icon">🍽️</div>
                <div class="nav-text">Recipes</div>
            </div>
            <div class="nav-item" data-page="dashboard" role="tab" aria-label="Mental health resources">
                <div class="nav-icon">🛠️</div>
                <div class="nav-text">Resources</div>
            </div>
            <div class="nav-item active" data-page="home" role="tab" aria-label="Home page">
                <div class="nav-icon">🏠</div>
                <div class="nav-text">Home</div>
            </div>
            <div class="nav-item" data-page="journal" role="tab" aria-label="Journal entries">
                <div class="nav-icon">📖</div>
                <div class="nav-text">Journal</div>
            </div>
            <div class="nav-item" data-page="todo" role="tab" aria-label="To-do list">
                <div class="nav-icon">✅</div>
                <div class="nav-text">To-Do</div>
            </div>
        </nav>



    <script>
    // Generate proper hazelnut icons dynamically
    function createHazelnutIcon(size) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = size;
        canvas.height = size;
        
        // Background with rounded corners (like Android adaptive icons)
        ctx.fillStyle = '#A2AE83';
        ctx.fillRect(0, 0, size, size);
        
        // Draw hazelnut emoji properly
        ctx.font = `${size * 0.65}px "Segoe UI Emoji", "Noto Color Emoji", "Apple Color Emoji", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('🌰', size / 2, size / 2);
        
        return canvas.toDataURL('image/png');
    }
    
    // Update manifest with proper icons after page loads
    window.addEventListener('load', () => {
        const icon192 = createHazelnutIcon(192);
        const icon512 = createHazelnutIcon(512);
        
        // Create updated manifest
        const manifest = {
            "name": "Hazel - Mental Health Support",
            "short_name": "Hazel",
            "description": "Mental health support app with journaling, resources, and crisis support",
            "start_url": "./",
            "display": "standalone",
            "orientation": "portrait",
            "background_color": "#A2AE83",
            "theme_color": "#A2AE83",
            "icons": [
                {
                    "src": icon192,
                    "type": "image/png",
                    "sizes": "192x192",
                    "purpose": "any maskable"
                },
                {
                    "src": icon512,
                    "type": "image/png", 
                    "sizes": "512x512",
                    "purpose": "any maskable"
                }
            ],
            "shortcuts": [
                {
                    "name": "New Journal Entry",
                    "short_name": "Journal",
                    "url": "/?action=new-journal"
                },
                {
                    "name": "Crisis Support",
                    "short_name": "Crisis",
                    "url": "/?action=crisis"
                }
            ]
        };
        
        // Replace manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        
        const oldManifest = document.querySelector('link[rel="manifest"]');
        if (oldManifest) oldManifest.remove();
        
        const newManifest = document.createElement('link');
        newManifest.rel = 'manifest';
        newManifest.href = manifestURL;
        document.head.appendChild(newManifest);
    });
        // Enhanced PWA App with Mobile-First Features and Fullscreen Support
        class HazelApp {
            constructor() {
                this.currentPage = 'home';
                this.journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                this.streak = parseInt(localStorage.getItem('streak') || '0');
                this.lastLoginDate = localStorage.getItem('lastLoginDate');
                this.sobrietyStartDate = localStorage.getItem('sobrietyStartDate');
                this.tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                this.nextTaskId = parseInt(localStorage.getItem('nextTaskId') || '1');
                this.selectedMood = null;
                this.isEditingEntry = false;
                this.editingEntryId = null;

                // In your constructor, add this property:
                this.foodMenus = {
                    breakfast: [
                        { name: "Chocolate Chip Pancakes", description: "Fluffy, golden pancakes studded with melty chocolate chips.", calories: "450 cal" },
                        { name: "Avocado Toast Supreme", description: "Multigrain bread topped with smashed avocado, cherry tomatoes, feta cheese.", calories: "380 cal" },
                        { name: "Berry Protein Smoothie Bowl", description: "Thick smoothie bowl topped with fresh berries and granola.", calories: "320 cal" }
                    ],
                    lunch: [
                        { name: "Grilled Chicken Caesar Salad", description: "Crisp romaine lettuce, grilled chicken breast, parmesan cheese.", calories: "420 cal" },
                        { name: "Mediterranean Quinoa Bowl", description: "Fluffy quinoa with cucumber, tomatoes, olives, feta cheese.", calories: "380 cal" },
                        { name: "BBQ Pulled Pork Sandwich", description: "Slow-cooked pulled pork with tangy BBQ sauce on brioche bun.", calories: "650 cal" }
                    ],
                    dinner: [
                        { name: "Herb-Crusted Salmon", description: "Atlantic salmon with herb crust and roasted vegetables.", calories: "580 cal" },
                        { name: "Ribeye Steak & Potatoes", description: "Perfectly grilled ribeye with garlic mashed potatoes.", calories: "750 cal" },
                        { name: "Thai Green Curry", description: "Coconut curry with vegetables served with jasmine rice.", calories: "480 cal" }
                    ],
                    snacks: [
                        { name: "Loaded Nachos", description: "Crispy tortilla chips with melted cheese and guacamole.", calories: "540 cal" },
                        { name: "Buffalo Chicken Wings", description: "Crispy wings in spicy buffalo sauce with ranch.", calories: "380 cal" },
                        { name: "Chocolate Brownie Sundae", description: "Warm brownie with vanilla ice cream and chocolate sauce.", calories: "620 cal" }
                    ]
                };

                this.init();
            }

            init() {
                this.setupFullscreen();
                this.setupEventListeners();
                this.setupTouchEnhancements();
                this.setupPWA();
                this.updateStreak();
                this.loadJournalEntries();
                this.showTabContent('self-harm');
                this.updateSobrietyDisplay();
                this.loadTasks();
                this.initSobrietyTracker();
                this.setupAccessibility();
                // this.setupEmergencyButton();
                this.preventZoom();
            }

            setupFullscreen() {
                // Add fullscreen class to body
                document.body.classList.add('fullscreen-mode');
                
                // Hide address bar on mobile devices
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                    }, 0);
                });

                // Prevent scrolling on the main container
                document.addEventListener('touchmove', (e) => {
                    if (e.target === document.body || e.target === document.documentElement) {
                        e.preventDefault();
                    }
                }, { passive: false });

                // Handle orientation changes
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                        this.adjustViewportHeight();
                    }, 100);
                });

                // Set initial viewport height
                this.adjustViewportHeight();
            }

            adjustViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }

            preventZoom() {
                // Prevent double-tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (event) => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // Prevent pinch zoom
                document.addEventListener('gesturestart', (e) => {
                    e.preventDefault();
                });

                document.addEventListener('gesturechange', (e) => {
                    e.preventDefault();
                });

                document.addEventListener('gestureend', (e) => {
                    e.preventDefault();
                });
            }

            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        this.navigateTo(item.dataset.page);
                        this.addHapticFeedback();
                    });
                });

                // Mood selection
                document.querySelectorAll('.emoji-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.handleMoodSelect(btn.dataset.mood);
                        this.addHapticFeedback();
                    });
                });

                // Support panel
                document.querySelectorAll('.support-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.handleSupportAction(btn.dataset.action);
                    });
                });

                // Dashboard tabs
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.showTabContent(tab.dataset.tab);
                        this.addHapticFeedback();
                    });
                });

                // Journal
                document.getElementById('newEntryBtn').addEventListener('click', () => {
                    this.showNewEntryForm();
                });

                // Sobriety tracker
                document.getElementById('editSobrietyBtn').addEventListener('click', () => {
                    this.editSobrietyDate();
                });

                // Tasks
                document.getElementById('addTaskBtn').addEventListener('click', () => {
                    this.addTask();
                });

                document.getElementById('taskInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.addTask();
                    }
                });

                // Modal
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    this.hideModal();
                });

                document.querySelectorAll('.menu-category').forEach(category => {
                    category.addEventListener('click', (e) => {
                        this.showFoodItems(category.dataset.category);
                        this.addHapticFeedback();
                    });
                });

                // Hotlines
                document.querySelectorAll('.hotline-call').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const number = btn.dataset.number;
                        window.location.href = `tel:${number}`;
                    });
                });

                document.querySelectorAll('.hotline-info').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const url = btn.dataset.url;
                        window.open(url, '_blank');
                    });
                });
            }

            setupTouchEnhancements() {
                // Add touch ripple effects to buttons
                document.querySelectorAll('.emoji-btn, .btn, .nav-item').forEach(el => {
                    el.addEventListener('touchstart', (e) => {
                        el.style.transform = 'scale(0.98)';
                    });
                    
                    el.addEventListener('touchend', (e) => {
                        setTimeout(() => {
                            el.style.transform = '';
                        }, 150);
                    });
                });
            }

            setupAccessibility() {
                // Keyboard navigation for tabs
                document.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('nav-item')) {
                        const navItems = Array.from(document.querySelectorAll('.nav-item'));
                        const currentIndex = navItems.indexOf(e.target);
                        let nextIndex;
                        
                        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                            nextIndex = currentIndex > 0 ? currentIndex - 1 : navItems.length - 1;
                        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                            nextIndex = currentIndex < navItems.length - 1 ? currentIndex + 1 : 0;
                        }
                        
                        if (nextIndex !== undefined) {
                            this.navigateTo(navItems[nextIndex].dataset.page);
                            navItems[nextIndex].focus();
                            e.preventDefault();
                        }
                    }
                });
            }

            setupEmergencyButton() {
                // Show emergency button based on mood state
                //this.toggleEmergencyButton();
            }

            addHapticFeedback() {
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
            }

            announce(message) {
                const liveRegion = document.getElementById('live-announcements');
                if (liveRegion) {
                    liveRegion.textContent = message;
                    setTimeout(() => {
                        liveRegion.textContent = '';
                    }, 1000);
                }
            }

            navigateTo(page) {
                // Add loading state
                document.body.classList.add('loading');
                
                // Hide all pages
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                // Show selected page
                setTimeout(() => {
                    document.getElementById(page).classList.add('active');
                    document.querySelector(`[data-page="${page}"]`).classList.add('active');
                    document.body.classList.remove('loading');
                    
                    // Scroll to top
                    document.getElementById(page).scrollTop = 0;
                    
                    // Update current page
                    this.currentPage = page;
                    
                    // Update URL without page refresh
                    if (history.pushState) {
                        history.pushState({ page }, null, `#${page}`);
                    }
                    
                    this.announce(`Navigated to ${page} page`);
                }, 100);
            }

            showFoodItems(category) {
                    // Hide the categories grid
                    document.querySelector('.menu-categories').style.display = 'none';
                    
                    // Create and show food items
                    const menusPage = document.getElementById('menus');
                    let foodItemsContainer = document.getElementById('foodItemsContainer');
                    
                    if (!foodItemsContainer) {
                        foodItemsContainer = document.createElement('div');
                        foodItemsContainer.id = 'foodItemsContainer';
                        menusPage.appendChild(foodItemsContainer);
                    }
                    
                    const items = this.foodMenus[category] || [];
                    foodItemsContainer.innerHTML = `
                        <button onclick="window.hazelApp.showMenuCategories()" style="background: var(--secondary-color); color: white; border: none; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-full); font-size: var(--text-sm); font-weight: 600; cursor: pointer; margin-bottom: var(--space-lg);">← Back to Categories</button>
                        <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                            ${items.map(item => `
                                <div style="background: var(--surface-color); border-radius: var(--radius-lg); padding: var(--space-lg); box-shadow: var(--shadow-md);">
                                    <div style="font-size: var(--text-lg); font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-sm);">${item.name}</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.5; margin-bottom: var(--space-sm);">${item.description}</div>
                                    <div style="font-size: var(--text-xs); color: var(--primary-color); font-weight: 600;">${item.calories}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    foodItemsContainer.style.display = 'block';
                }
                
                showMenuCategories() {
                    // Show the categories grid
                    document.querySelector('.menu-categories').style.display = 'grid';
                    
                    // Hide food items
                    const foodItemsContainer = document.getElementById('foodItemsContainer');
                    if (foodItemsContainer) {
                        foodItemsContainer.style.display = 'none';
                    }
                }

            handleMoodSelect(mood) {
                this.selectedMood = mood;
                
                // Show support panel for sad moods
                if (mood === 'very-sad' || mood === 'sad') {
                    this.showSupportPanel();
                } 
                this.announce(`Mood selected: ${mood}`);
            }

            showSupportPanel() {
                document.getElementById('supportPanel').classList.add('show');
            }

            hideSupportPanel() {
                document.getElementById('supportPanel').classList.remove('show');
            }
            
            handleSupportAction(action) {
                switch(action) {
                    case 'journal':
                        this.hideSupportPanel();
                        this.navigateTo('journal');
                        setTimeout(() => this.showNewEntryForm(), 200);
                        break;
                    case 'hotlines':
                        this.hideSupportPanel();
                        this.showHotlines();
                        break;
                    case 'dashboard':
                        this.hideSupportPanel();
                        this.navigateTo('dashboard');
                        break;
                    case 'close':
                        this.hideSupportPanel();
                        break;
                }
            }

            showHotlines() {
                document.getElementById('hotlinesModal').classList.add('show');
            }

            hideModal() {
                document.getElementById('hotlinesModal').classList.remove('show');
            }

            // Sobriety Tracker Methods
            initSobrietyTracker() {
                if (!this.sobrietyStartDate) {
                    this.sobrietyStartDate = new Date().toISOString();
                    localStorage.setItem('sobrietyStartDate', this.sobrietyStartDate);
                }
                this.updateSobrietyDisplay();
            }

            updateSobrietyDisplay() {
                if (!this.sobrietyStartDate) return;

                const startDate = new Date(this.sobrietyStartDate);
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                document.getElementById('sobrietyDays').textContent = diffDays;

                const motivationText = this.getMotivationText(diffDays);
                document.getElementById('motivationText').textContent = motivationText;

                const milestone = this.getNextMilestone(diffDays);
                const progress = this.getMilestoneProgress(diffDays, milestone);
                
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('milestoneText').textContent = this.getMilestoneText(diffDays, milestone);
            }

            getMotivationText(days) {
                if (days === 0) return "Every day is a victory! Your journey starts now.";
                if (days < 7) return `${days} day${days === 1 ? '' : 's'} of strength! Keep going.`;
                if (days < 30) return `${Math.floor(days/7)} week${Math.floor(days/7) === 1 ? '' : 's'}+ of positive choices! Your strength shines.`;
                if (days < 90) return `${Math.floor(days/30)} month${Math.floor(days/30) === 1 ? '' : 's'}+ of positive choices! Your strength shines.`;
                if (days < 365) return `${Math.floor(days/30)} months+ of incredible progress! You're amazing.`;
                return `${Math.floor(days/365)} year${Math.floor(days/365) === 1 ? '' : 's'}+ of transformation! You're inspiring.`;
            }

            getNextMilestone(days) {
                const milestones = [7, 30, 90, 180, 365, 730];
                return milestones.find(m => m > days) || milestones[milestones.length - 1];
            }

            getMilestoneProgress(days, milestone) {
                if (days >= milestone) return 100;
                const previousMilestone = [0, 7, 30, 90, 180, 365].find((m, i, arr) => arr[i + 1] === milestone) || 0;
                return Math.floor(((days - previousMilestone) / (milestone - previousMilestone)) * 100);
            }

            getMilestoneText(days, milestone) {
                if (days >= milestone) return `Milestone reached! Next: ${this.getNextMilestone(milestone)} days`;
                const remaining = milestone - days;
                return `${remaining} day${remaining === 1 ? '' : 's'} left to ${milestone} days`;
            }

            editSobrietyDate() {
                const currentDate = this.sobrietyStartDate ? new Date(this.sobrietyStartDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
                const newDate = prompt("Enter your sobriety start date (YYYY-MM-DD):", currentDate);
                
                if (newDate && newDate !== currentDate) {
                    this.sobrietyStartDate = new Date(newDate).toISOString();
                    localStorage.setItem('sobrietyStartDate', this.sobrietyStartDate);
                    this.updateSobrietyDisplay();
                    this.announce('Sobriety date updated');
                }
            }

            // Streak Management
            updateStreak() {
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                
                if (this.lastLoginDate === yesterday) {
                    this.streak++;
                } else if (this.lastLoginDate !== today) {
                    this.streak = 1;
                }
                
                localStorage.setItem('streak', this.streak.toString());
                localStorage.setItem('lastLoginDate', today);
                
                this.displayStreak();
            }

            displayStreak() {
                const container = document.getElementById('streakContainer');
                container.innerHTML = '';
                
                const heartsToShow = Math.min(this.streak, 7);
                for (let i = 0; i < heartsToShow; i++) {
                    const heart = document.createElement('span');
                    heart.className = 'heart';
                    heart.textContent = '❤️';
                    container.appendChild(heart);
                }
                
                if (this.streak >= 7) {
                    const hazelnut = document.createElement('span');
                    hazelnut.className = 'hazelnut';
                    hazelnut.textContent = '🌰';
                    container.appendChild(hazelnut);
                }
            }

            // Dashboard Tab Content
            showTabContent(tab) {
                // Update active tab
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                
                const content = document.getElementById('tabContent');
                
                const tabData = {
                    'self-harm': {
                        title: 'Self Harm Support',
                        alternatives: [
                            'Draw or create art',
                            'Write in a journal',
                            'Listen to music',
                            'Pet an animal',
                            'Eat some sour sweets',
                            'Watch a comfort show/movie',
                            'Take deep breaths and go for a walk'
                        ],
                        resources: [
                            { name: 'Pieta House', url: 'https://www.pieta.ie/how-we-can-help/' },
                            { name: 'HSE Mental Health', url: 'https://www.hse.ie/eng/services/list/4/mental-health-services/nosp/resources/selfharmyoung.pdf' },
                            { name: 'Tusla', url: 'https://www.tusla.ie/parenting-24-seven/12-years/child-safety-practices-reduce-injury/self-harm/' },
                            { name: 'St Patrick\'s MHS', url: 'https://www.stpatricks.ie/media-centre/blogs-articles/2023/february/self-harm-causes-and-supports' }
                        ]
                    },
                    'ed': {
                        title: 'Eating Disorder Support',
                        alternatives: [
                            'Talk to a trusted friend or family member',
                            'Drink water or herbal tea',
                            'Practice mindful eating',
                            'Write about your feelings',
                            'Use positive affirmations',
                            'Call a support line',
                            'Join an online support group',
                            'Practice gentle movement or yoga'
                        ],
                        resources: [
                            { name: 'BodyWhys', url: 'https://bodywhys.ie' },
                            { name: 'HSE Eating Disorders', url: 'https://www.hse.ie/eng/about/who/cspd/ncps/mental-health/eating-disorders/' },
                            { name: 'National ED Recovery Centre', url: 'https://nedrc.ie/' },
                            { name: 'St Patrick\'s MHS', url: 'https://www.stpatricks.ie/mental-health/eating-disorders' }
                        ]
                    },
                    'anxiety': {
                        title: 'Anxiety Support',
                        alternatives: [
                            'Practice deep breathing exercises',
                            'Use the 5-4-3-2-1 grounding technique',
                            'Go for a short walk outside',
                            'Listen to calming music',
                            'Squeeze a stress ball or fidget toy',
                            'Write down your worries',
                            'Do progressive muscle relaxation',
                            'Call someone you trust'
                        ],
                        resources: [
                            { name: 'Aware', url: 'https://www.aware.ie/information/anxiety/' },
                            { name: 'HSE Anxiety Support', url: 'https://www2.hse.ie/conditions/anxiety-tips-and-self-help/' },
                            { name: 'Spunout', url: 'https://spunout.ie/category/mental-health/anxiety-stress' },
                            { name: 'St Patrick\'s MHS', url: 'https://www.stpatricks.ie/mental-health/anxiety' }
                        ]
                    },
                    'depression': {
                        title: 'General Mental Health Support',
                        alternatives: [
                            'Listen to uplifting music',
                            'Take a warm shower or bath',
                            'Complete one small task',
                            'Text or call a supportive friend',
                            'Spend time in nature or by a window',
                            'Create something simple',
                            'Practice gratitude by listing 3 good things',
                            'Do gentle movement or stretching'
                        ],
                        resources: [
                            { name: 'Aware', url: 'https://www.aware.ie/information/depression/' },
                            { name: 'HSE Depression Support', url: 'https://www2.hse.ie/conditions/depression/' },
                            { name: 'Spunout', url: 'https://spunout.ie/category/mental-health/depression' },
                            { name: 'St Patrick\'s MHS', url: 'https://www.stpatricks.ie/mental-health/depression' }
                        ]
                    }
                };

                const data = tabData[tab];
                
                content.innerHTML = `
                    <div class="section-title">${data.title}</div>
                    <div class="section-divider"></div>
                    <div class="alternatives-list">
                        ${data.alternatives.map(alt => `• ${alt}`).join('<br>')}
                    </div>
                    ${data.resources.map(resource => 
                        `<button class="resource-btn" onclick="window.open('${resource.url}', '_blank')">${resource.name}</button>`
                    ).join('')}
                `;
            }

            // Journal Methods
            loadJournalEntries() {
                const container = document.getElementById('journalEntries');
                
                if (this.journalEntries.length === 0) {
                    container.innerHTML = '<div class="empty-state">No journal entries yet. Start writing to track your thoughts and feelings.</div>';
                    return;
                }
                
                container.innerHTML = this.journalEntries.map(entry => `
                    <div class="journal-entry" data-entry-id="${entry.id}">
                        <div class="entry-title">${entry.title}</div>
                        <div class="entry-date">${new Date(entry.date).toLocaleDateString()}</div>
                        ${entry.mood ? `<div class="entry-mood">${this.getMoodEmoji(entry.mood)}</div>` : ''}
                    </div>
                `).join('');

                // Add click listeners to entries
                container.querySelectorAll('.journal-entry').forEach(entry => {
                    entry.addEventListener('click', () => {
                        this.viewEntry(parseInt(entry.dataset.entryId));
                    });
                });
            }

            getMoodEmoji(mood) {
                const moodEmojis = {
                    'very-sad': '😢',
                    'sad': '😔',
                    'neutral': '😐',
                    'happy': '😊',
                    'very-happy': '😄'
                };
                return moodEmojis[mood] || '';
            }

            showNewEntryForm() {
                const today = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                document.getElementById('journalEntries').innerHTML = `
                    <div class="entry-form">
                        <h3 style="color: #435334; margin-bottom: var(--space-lg);">${this.isEditingEntry ? 'Edit Entry' : 'New Entry'} - ${today}</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" id="entryTitle" class="form-input" placeholder="How are you feeling?" value="${this.isEditingEntry ? this.getEditingEntry().title : ''}" autocomplete="off">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Write your thoughts</label>
                            <textarea id="entryContent" class="form-textarea" placeholder="Express yourself here...">${this.isEditingEntry ? this.getEditingEntry().content : ''}</textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="hazelApp.loadJournalEntries()">Cancel</button>
                            <button class="btn btn-primary" onclick="hazelApp.saveEntry()">Save Entry</button>
                        </div>
                    </div>
                `;
                
                // Focus on title input
                setTimeout(() => {
                    document.getElementById('entryTitle').focus();
                }, 100);
            }

            getEditingEntry() {
                return this.journalEntries.find(e => e.id === this.editingEntryId) || { title: '', content: '' };
            }

            saveEntry() {
                const title = document.getElementById('entryTitle').value.trim();
                const content = document.getElementById('entryContent').value.trim();
                
                if (!title || !content) {
                    alert('Please fill in both title and content');
                    return;
                }
                
                if (this.isEditingEntry) {
                    // Update existing entry
                    const entryIndex = this.journalEntries.findIndex(e => e.id === this.editingEntryId);
                    if (entryIndex !== -1) {
                        this.journalEntries[entryIndex] = {
                            ...this.journalEntries[entryIndex],
                            title,
                            content,
                            lastModified: new Date().toISOString()
                        };
                    }
                } else {
                    // Create new entry
                    const entry = {
                        id: Date.now(),
                        title: title,
                        content: content,
                        mood: this.selectedMood,
                        date: new Date().toISOString(),
                        tags: []
                    };
                    
                    this.journalEntries.unshift(entry);
                }
                
                localStorage.setItem('journalEntries', JSON.stringify(this.journalEntries));
                
                this.selectedMood = null;
                this.isEditingEntry = false;
                this.editingEntryId = null;
                this.loadJournalEntries();
                this.announce('Journal entry saved');
            }

            viewEntry(id) {
                const entry = this.journalEntries.find(e => e.id === id);
                if (!entry) return;
                
                const moodEmoji = this.getMoodEmoji(entry.mood);
                
                document.getElementById('journalEntries').innerHTML = `
                    <div class="entry-form">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-lg);">
                            <h3 style="color: #435334;">${entry.title}</h3>
                            ${moodEmoji ? `<span style="font-size: 1.5rem;">${moodEmoji}</span>` : ''}
                        </div>
                        
                        <div style="color: var(--text-secondary); margin-bottom: var(--space-md); font-size: var(--text-sm);">
                            ${new Date(entry.date).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </div>
                        
                        <div style="line-height: 1.6; margin-bottom: var(--space-xl); white-space: pre-wrap;">${entry.content}</div>
                        
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="hazelApp.loadJournalEntries()">Back</button>
                            <button class="btn btn-primary" onclick="hazelApp.editEntry(${entry.id})">Edit</button>
                            <button class="btn btn-secondary" onclick="hazelApp.deleteEntry(${entry.id})" style="background: var(--error-color); color: white;">Delete</button>
                        </div>
                    </div>
                `;
            }

            editEntry(id) {
                this.isEditingEntry = true;
                this.editingEntryId = id;
                this.showNewEntryForm();
            }

            deleteEntry(id) {
                if (confirm('Are you sure you want to delete this entry?')) {
                    this.journalEntries = this.journalEntries.filter(e => e.id !== id);
                    localStorage.setItem('journalEntries', JSON.stringify(this.journalEntries));
                    this.loadJournalEntries();
                    this.announce('Journal entry deleted');
                }
            }

            loadTasks() {
                const container = document.getElementById('tasksContainer');
                
                if (this.tasks.length === 0) {
                    container.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: var(--space-xl);">No tasks yet. Add one above!</div>';
                    return;
                }
                
                container.innerHTML = this.tasks.map(task => {
                    const subtasksExpanded = task.subtasksExpanded ? 'expanded' : '';
                    const subtasksHtml = (task.subtasks || []).map(subtask => `
                        <div class="subtask-item">
                            <div class="subtask-checkbox ${subtask.completed ? 'completed' : ''}" 
                                 data-task-id="${task.id}" data-subtask-id="${subtask.id}"></div>
                            <div class="subtask-text ${subtask.completed ? 'completed' : ''}">${subtask.text}</div>
                        </div>
                    `).join('');
            
                    return `
                        <div class="task-item">
                            <div class="task-checkbox ${task.completed ? 'completed' : ''}" data-task-id="${task.id}"></div>
                            <div class="task-content">
                                <div class="task-header">
                                    <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                                    <div class="task-actions">
                                        ${(task.subtasks && task.subtasks.length > 0) ? 
                                            `<button class="task-expand-btn" data-task-id="${task.id}">
                                                ${task.subtasksExpanded ? '▼' : '▶'}
                                            </button>` : ''
                                        }
                                        <button class="add-subtask-btn" data-task-id="${task.id}">+</button>
                                    </div>
                                </div>
                                <div class="subtasks ${subtasksExpanded}" data-task-id="${task.id}">
                                    ${subtasksHtml}
                                    <input type="text" class="subtask-input" data-task-id="${task.id}" 
                                           placeholder="Add subtask..." style="display: none;">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.addTaskEventListeners();
            }
            
            addTask() {
                const input = document.getElementById('taskInput');
                const text = input.value.trim();
                
                if (!text) return;
                
                const task = {
                    id: this.nextTaskId++,
                    text: text,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    subtasks: [],              // Make sure this line is added
                    subtasksExpanded: false    // Make sure this line is added
                };
                
                this.tasks.push(task);
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                localStorage.setItem('nextTaskId', this.nextTaskId.toString());
                
                input.value = '';
                this.loadTasks();
                this.announce('Task added');
            }

            toggleTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.loadTasks();
                    this.announce(task.completed ? 'Task completed' : 'Task uncompleted');
                }
            }

            addTaskEventListeners() {
                // Remove any existing listeners first
                const existingListeners = document.querySelectorAll('.task-checkbox, .subtask-checkbox, .task-expand-btn, .add-subtask-btn, .subtask-input');
                existingListeners.forEach(el => {
                    el.replaceWith(el.cloneNode(true));
                });
            
                // Main task checkboxes
                document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', () => {
                        const taskId = parseInt(checkbox.dataset.taskId);
                        if (!checkbox.dataset.subtaskId) {
                            this.toggleTask(taskId);
                        }
                    });
                });
            
                // Subtask checkboxes
                document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', () => {
                        const taskId = parseInt(checkbox.dataset.taskId);
                        const subtaskId = parseInt(checkbox.dataset.subtaskId);
                        this.toggleSubtask(taskId, subtaskId);
                    });
                });
            
                // Expand/collapse buttons
                document.querySelectorAll('.task-expand-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const taskId = parseInt(btn.dataset.taskId);
                        this.toggleTaskExpansion(taskId);
                    });
                });
            
                // Add subtask buttons - THIS IS THE KEY ONE
                document.querySelectorAll('.add-subtask-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const taskId = parseInt(btn.dataset.taskId);
                        console.log('Add subtask clicked for task:', taskId); // Debug line
                        this.showSubtaskInput(taskId);
                    });
                });
            
                // Subtask inputs
                document.querySelectorAll('.subtask-input').forEach(input => {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const taskId = parseInt(input.dataset.taskId);
                            const text = input.value.trim();
                            if (text) {
                                this.addSubtask(taskId, text);
                                input.value = '';
                                input.style.display = 'none';
                            }
                        } else if (e.key === 'Escape') {
                            input.style.display = 'none';
                            input.value = '';
                        }
                    });
            
                    input.addEventListener('blur', () => {
                        setTimeout(() => {
                            input.style.display = 'none';
                            input.value = '';
                        }, 150);
                    });
                });
            }

            showSubtaskInput(taskId) {
                console.log('Showing subtask input for task:', taskId);
                
                // First, make sure the subtasks container is visible
                const subtasksContainer = document.querySelector(`.subtasks[data-task-id="${taskId}"]`);
                console.log('Found subtasks container:', subtasksContainer);
                if (subtasksContainer) {
                    subtasksContainer.style.display = 'block';
                    subtasksContainer.classList.add('expanded');
                }
                
                const input = document.querySelector(`.subtask-input[data-task-id="${taskId}"]`);
                console.log('Found input:', input);
                if (input) {
                    // More aggressive styling
                    input.style.display = 'block';
                    input.style.visibility = 'visible';
                    input.style.opacity = '1';
                    input.style.height = 'auto';
                    input.style.minHeight = '32px';
                    input.style.background = 'rgba(255, 255, 255, 0.2)';
                    input.style.border = '1px solid rgba(194, 171, 249, 0.8)';
                    input.style.borderRadius = '4px';
                    input.style.padding = '8px';
                    input.style.color = 'white';
                    input.style.fontSize = '14px';
                    input.style.marginTop = '8px';
                    input.style.width = '100%';
                    input.style.position = 'relative';
                    input.style.zIndex = '10';
                    
                    // Force focus and scroll into view
                    setTimeout(() => {
                        input.focus();
                        input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            }
            
            addSubtask(taskId, text) {
                console.log('Adding subtask:', text, 'to task:', taskId); // Debug line
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    if (!task.subtasks) {
                        task.subtasks = [];
                    }
                    
                    const subtask = {
                        id: Date.now(),
                        text: text,
                        completed: false,
                        createdAt: new Date().toISOString()
                    };
                    
                    task.subtasks.push(subtask);
                    task.subtasksExpanded = true;
                    
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.loadTasks();
                    this.announce('Subtask added');
                }
            }
            
            toggleSubtask(taskId, subtaskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task && task.subtasks) {
                    const subtask = task.subtasks.find(s => s.id === subtaskId);
                    if (subtask) {
                        subtask.completed = !subtask.completed;
                        
                        const allSubtasksCompleted = task.subtasks.every(s => s.completed);
                        if (allSubtasksCompleted && task.subtasks.length > 0) {
                            task.completed = true;
                        } else if (task.completed && !subtask.completed) {
                            task.completed = false;
                        }
                        
                        localStorage.setItem('tasks', JSON.stringify(this.tasks));
                        this.loadTasks();
                        this.announce(subtask.completed ? 'Subtask completed' : 'Subtask uncompleted');
                    }
                }
            }
            
            toggleTaskExpansion(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.subtasksExpanded = !task.subtasksExpanded;
                    localStorage.setItem('tasks', JSON.stringify(this.tasks));
                    this.loadTasks();
                }
            }
            
            // PWA Setup
            setupPWA() {
                // Register service worker
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', async () => {
                        try {
                            const swBlob = new Blob([this.createServiceWorker()], { type: 'application/javascript' });
                            const swUrl = URL.createObjectURL(swBlob);
                            
                            const registration = await navigator.serviceWorker.register(swUrl);
                            console.log('SW registered:', registration);
                            
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        this.showUpdateNotification();
                                    }
                                });
                            });
                        } catch (error) {
                            console.log('SW registration failed:', error);
                        }
                    });
                }

                // Handle PWA install prompt
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    this.showInstallButton(deferredPrompt);
                });

                // Handle URL parameters for shortcuts
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                if (action) {
                    this.handleShortcutAction(action);
                }

                // Handle fullscreen mode changes
                document.addEventListener('fullscreenchange', () => {
                    if (document.fullscreenElement) {
                        document.body.classList.add('fullscreen-mode');
                    } else {
                        document.body.classList.remove('fullscreen-mode');
                    }
                });
            }

            createServiceWorker() {
                return `
                    const CACHE_NAME = 'hazel-v2';
                    const urlsToCache = [
                        '/',
                        '/index.html',
                        '/manifest.json'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                        self.skipWaiting();
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                        self.clients.claim();
                    });
                `;
            }

            handleShortcutAction(action) {
                switch(action) {
                    case 'new-journal':
                        this.navigateTo('journal');
                        setTimeout(() => this.showNewEntryForm(), 200);
                        break;
                    case 'crisis':
                        this.showHotlines();
                        break;
                }
            }

            showUpdateNotification() {
                const notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.innerHTML = `
                    <div style="background: var(--primary-color); color: white; padding: var(--space-md); border-radius: var(--radius-md); margin: var(--space-md); text-align: center;">
                        App update available! 
                        <button onclick="window.location.reload()" style="background: white; color: var(--primary-color); border: none; padding: var(--space-sm); border-radius: var(--radius-sm); margin-left: var(--space-sm);">
                            Update Now
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 10000);
            }

            showInstallButton(deferredPrompt) {
                const installButton = document.createElement('button');
                installButton.textContent = 'Install App';
                installButton.className = 'btn btn-secondary';
                installButton.style.cssText = `
                    position: absolute;
                    top: calc(20px + var(--safe-area-inset-top));
                    right: 20px;
                    z-index: var(--z-tooltip);
                    font-size: var(--text-sm);
                    padding: var(--space-sm) var(--space-md);
                `;
                
                installButton.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log('Install prompt outcome:', outcome);
                        installButton.remove();
                    }
                });
                
                document.body.appendChild(installButton);
            }
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.hazelApp = new HazelApp();
        });

        // Handle browser back button
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.page && window.hazelApp) {
                window.hazelApp.navigateTo(e.state.page);
            }
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            console.log('App is online');
            document.body.classList.remove('offline');
        });

        window.addEventListener('offline', () => {
            console.log('App is offline');
            document.body.classList.add('offline');
        });

        // Handle viewport resize
        window.addEventListener('resize', () => {
            if (window.hazelApp) {
                window.hazelApp.adjustViewportHeight();
            }
        });

        // Detect if running on iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Only run iOS-specific code on iOS devices
        if (isIOS()) {
            // Generate proper PNG icons for iOS only
            function createIOSIcon(size) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;
                
                // iOS-style background
                ctx.fillStyle = '#A2AE83';
                ctx.fillRect(0, 0, size, size);
                
                // iOS emoji rendering
                ctx.font = `${size * 0.6}px "Apple Color Emoji", "Segoe UI Emoji", Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('🌰', size / 2, size / 2);
                
                return canvas.toDataURL('image/png');
            }

            // Update Apple Touch Icons after page loads (iOS only)
            window.addEventListener('load', () => {
                // Only proceed if this is actually iOS
                if (!isIOS()) return;
                
                // Generate PNG versions
                const icon180 = createIOSIcon(180);
                const icon152 = createIOSIcon(152);
                const icon120 = createIOSIcon(120);
                
                // Replace existing apple-touch-icon links
                const existingIcons = document.querySelectorAll('link[rel="apple-touch-icon"]');
                existingIcons.forEach(icon => icon.remove());
                
                // Add new PNG icons
                const sizes = [
                    { size: '180x180', dataURL: icon180 },
                    { size: '152x152', dataURL: icon152 },
                    { size: '120x120', dataURL: icon120 }
                ];
                
                sizes.forEach(iconData => {
                    const link = document.createElement('link');
                    link.rel = 'apple-touch-icon';
                    link.sizes = iconData.size;
                    link.href = iconData.dataURL;
                    document.head.appendChild(link);
                });
                
                // Add fallback without sizes
                const fallback = document.createElement('link');
                fallback.rel = 'apple-touch-icon';
                fallback.href = icon180;
                document.head.appendChild(fallback);
            });
        }

        // Android-specific fixes (if needed)
        function isAndroid() {
            return /Android/i.test(navigator.userAgent);
        }

        if (isAndroid()) {
            // Ensure Android layout works properly
            window.addEventListener('load', () => {
                // Force re-layout if needed
                document.body.style.minHeight = '100vh';
                
                // Make sure container takes full height
                const container = document.querySelector('.container');
                if (container) {
                    container.style.height = '100vh';
                    container.style.display = 'flex';
                    container.style.flexDirection = 'column';
                }
            });
        }
    </script>
</body>
</html>
